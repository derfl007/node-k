<script lang="ts" setup>
const canvasRef = ref<HTMLCanvasElement | null>(null)

const roadNodes = ref<{ x: number, y: number }[]>([
  { x: 384.862951, y: 226.965739 },
  { x: 215.853945, y: 124.10427 },
  { x: 143.826677, y: 144.463907 },
  { x: 217.46866, y: 183.817408 },
  { x: 279.599974, y: 159.228087 },
  { x: 288.19823, y: 139.271568 },
  { x: 304.698605, y: 81.907783 },
  { x: 312.417398, y: 196.846812 },
  { x: 288.219873, y: 169.691557 },
  { x: 374.356356, y: 226.431002 },
  { x: 582.906327, y: 137.464211 },
  { x: 368.22889, y: 217.628976 },
  { x: 615.310548, y: 115.279581 },
  { x: 621.61686, y: 115.636327 },
  { x: 579.046767, y: 189.123663 },
  { x: 566.933264, y: 201.966811 },
  { x: 484.703924, y: 218.779559 },
  { x: 519.729313, y: 217.939746 },
  { x: 402.743792, y: 260.260784 },
  { x: 362.206315, y: 232.532484 },
  { x: 384.285092, y: 235.155865 },
  { x: 316.483821, y: 255.368432 },
  { x: 366.455222, y: 162.681 },
  { x: 454.388443, y: 219.065256 },
  { x: 511.158788, y: 219.313493 },
  { x: 494.608643, y: 220.503194 },
  { x: 251.210985, y: 161.368554 },
  { x: 573.160093, y: 199.678301 },
  { x: 476.515043, y: 220.026409 },
  { x: 460.997734, y: 215.073085 },
  { x: 600.629341, y: 116.724952 },
  { x: 586.313124, y: 130.493373 },
  { x: 268.061515, y: 158.373558 },
  { x: 334.287543, y: 213.362777 },
  { x: 354.394791, y: 220.372463 },
  { x: 533.575357, y: 208.277464 },
  { x: 594.602614, y: 119.54968 },
  { x: 471.004844, y: 216.664349 },
  { x: 362.180359, y: 218.010878 },
  { x: 449.580939, y: 224.149239 },
  { x: 463.241696, y: 227.606644 },
  { x: 488.525574, y: 114.273224 },
  { x: 496.838025, y: 139.37746 },
  { x: 586.376092, y: 161.786144 },
  { x: 553.937275, y: 205.793443 },
  { x: 610.044094, y: 220.318507 },
  { x: 299.335485, y: 233.760252 },
  { x: 289.099616, y: 228.020667 },
  { x: 595.503414, y: 144.921851 },
  { x: 583.90145, y: 123.008376 },
  { x: 332.607395, y: 168.89963 },
  { x: 583.061377, y: 180.878781 },
  { x: 186.86463, y: 134.283095 },
  { x: 454.651454, y: 285.069838 },
  { x: 164.559985, y: 185.491165 },
  { x: 163.949689, y: 196.045373 },
  { x: 159.656799, y: 225.303021 },
  { x: 618.82203, y: 231.652844 },
  { x: 586.081711, y: 152.50221 },
  { x: 169.040782, y: 210.943135 },
  { x: 572.963283, y: 222.273598 },
  { x: 436.517258, y: 225.092746 },
  { x: 493.430445, y: 122.769474 },
  { x: 478.121953, y: 179.584207 },
  { x: 415.804332, y: 194.623741 },
  { x: 401.362132, y: 201.225549 },
  { x: 325.334495, y: 250.670753 },
  { x: 456.601773, y: 227.120788 },
  { x: 440.025285, y: 193.651883 },
  { x: 501.231651, y: 256.202663 },
  { x: 580.230139, y: 226.377515 },
  { x: 360.985271, y: 241.809335 },
  { x: 404.168226, y: 230.333929 },
  { x: 428.509774, y: 150.71225 },
  { x: 569.377919, y: 241.336072 },
  { x: 561.885628, y: 241.743272 },
  { x: 533.602069, y: 251.716827 },
  { x: 469.20765, y: 225.740543 },
  { x: 540.624638, y: 213.56952 },
  { x: 475.085997, y: 229.069373 },
  { x: 454.785205, y: 252.419878 },
  { x: 389.070015, y: 247.637912 },
  { x: 585.707533, y: 244.847192 },
  { x: 615.55945, y: 224.171133 },
  { x: 442.605121, y: 224.504056 },
  { x: 421.481526, y: 194.468883 },
  { x: 379.596265, y: 230.491376 },
  { x: 376.374073, y: 247.418237 },
  { x: 499.399061, y: 180.036156 },
  { x: 406.742782, y: 248.978495 },
  { x: 281.862733, y: 167.439997 },
  { x: 370.988996, y: 234.639464 },
  { x: 577.312898, y: 239.743788 },
  { x: 251.280691, y: 223.357555 },
  { x: 354.765502, y: 244.174837 },
  { x: 348.681627, y: 244.846991 },
  { x: 414.99494, y: 183.758226 },
  { x: 369.301049, y: 134.857003 },
  { x: 461.634723, y: 256.544877 },
  { x: 433.252984, y: 210.090232 },
  { x: 369.286354, y: 246.776343 },
  { x: 341.147597, y: 261.020717 },
  { x: 511.858407, y: 183.809843 },
  { x: 517.453778, y: 186.712935 },
  { x: 413.562016, y: 226.421737 },
  { x: 356.181069, y: 231.494104 },
  { x: 503.051361, y: 205.177106 },
  { x: 419.617632, y: 224.42962 },
  { x: 484.740309, y: 171.330937 },
  { x: 294.422279, y: 164.19013 },
  { x: 383.663245, y: 174.176293 },
  { x: 372.198413, y: 147.161846 },
  { x: 509.035584, y: 202.140683 },
  { x: 393.992333, y: 231.633067 },
  { x: 502.585117, y: 220.103883 },
  { x: 449.217416, y: 147.427883 },
  { x: 481.850634, y: 134.510409 },
  { x: 489.935666, y: 166.770681 },
  { x: 494.87399, y: 162.715235 },
  { x: 498.235095, y: 155.335333 },
  { x: 493.289657, y: 180.751172 },
  { x: 152.207986, y: 149.759828 },
  { x: 414.623565, y: 165.523223 },
  { x: 592.439105, y: 127.309843 },
  { x: 525.358243, y: 215.697922 },
  { x: 582.280079, y: 169.254141 },
  { x: 560.213398, y: 202.088943 },
  { x: 428.755828, y: 220.845646 },
  { x: 343.366453, y: 247.770808 },
  { x: 336.551369, y: 244.94811 },
  { x: 398.648133, y: 248.159276 },
  { x: 346.093154, y: 218.65999 },
  { x: 340.336744, y: 217.334818 },
  { x: 328.283427, y: 208.958772 },
  { x: 318.588525, y: 204.44831 },
  { x: 307.415844, y: 190.990623 },
  { x: 301.404561, y: 185.07254 },
  { x: 295.965337, y: 177.363443 },
  { x: 273.814244, y: 158.343867 },
  { x: 284.971068, y: 148.182925 },
  { x: 293.213292, y: 135.054566 },
  { x: 300.640088, y: 128.848741 },
  { x: 308.089601, y: 123.336834 },
  { x: 311.479531, y: 114.975568 },
  { x: 309.195197, y: 94.623599 },
  { x: 472.215796, y: 208.167411 },
  { x: 476.750355, y: 202.576437 },
  { x: 455.92674, y: 190.366106 },
  { x: 484.655517, y: 188.913066 },
  { x: 498.911513, y: 147.118877 },
  { x: 404.352886, y: 183.194303 },
  { x: 519.072968, y: 154.337644 },
  { x: 519.527932, y: 145.033741 },
  { x: 340.838215, y: 168.475546 },
  { x: 345.911978, y: 164.539102 },
  { x: 505.347819, y: 181.080916 },
  { x: 445.678562, y: 193.376861 },
  { x: 349.174585, y: 192.330808 },
  { x: 355.406593, y: 195.109953 },
  { x: 358.53356, y: 204.179051 },
  { x: 463.134067, y: 236.198485 },
  { x: 597.500334, y: 219.274653 },
  { x: 590.969866, y: 219.702531 },
  { x: 569.550446, y: 190.180633 },
  { x: 571.608111, y: 211.803466 },
  { x: 549.191557, y: 245.523037 },
  { x: 523.797732, y: 253.915003 },
  { x: 538.915109, y: 246.05713 },
  { x: 522.613347, y: 162.47607 },
  { x: 521.864382, y: 136.720168 },
  { x: 521.37172, y: 122.06918 },
  { x: 466.89709, y: 186.909402 },
  { x: 495.37104, y: 254.14889 },
  { x: 461.836043, y: 244.477586 },
  { x: 425.414192, y: 256.549158 },
  { x: 445.531722, y: 212.814804 },
  { x: 398.589577, y: 177.82421 },
  { x: 280.759875, y: 225.514038 },
  { x: 310.736745, y: 86.034223 },
  { x: 244.501889, y: 216.52782 },
  { x: 260.496553, y: 224.00792 },
  { x: 395.143917, y: 239.79596 },
  { x: 173.02967, y: 142.107331 },
  { x: 179.118291, y: 187.828023 },
  { x: 192.261868, y: 188.558002 },
  { x: 254.531851, y: 153.49169 },
  { x: 518.169274, y: 252.701456 },
  { x: 428.188684, y: 193.149494 },
  { x: 467.521049, y: 254.700176 },
  { x: 400.386061, y: 270.162962 },
  { x: 455.892535, y: 275.985654 },
  { x: 461.135148, y: 268.764305 },
  { x: 452.48718, y: 211.02183 },
  { x: 238.064823, y: 226.887288 },
  { x: 157.738323, y: 206.364083 },
  { x: 331.177942, y: 250.728675 },
  { x: 245.998031, y: 145.318427 },
  { x: 126.756518, y: 202.576723 },
  { x: 151.397913, y: 205.618633 },
  { x: 142.874837, y: 206.234714 },
  { x: 149.175008, y: 123.004325 },
  { x: 408.487182, y: 200.815576 },
  { x: 197.379886, y: 124.236963 },
  { x: 206.352428, y: 123.458686 },
  { x: 189.170873, y: 126.718665 },
  { x: 268.643878, y: 224.443112 },
  { x: 229.312509, y: 184.032008 },
  { x: 142.571961, y: 100.347978 },
  { x: 138.443328, y: 90.894543 },
  { x: 150.561049, y: 133.235898 },
  { x: 178.910528, y: 139.997542 },
  { x: 222.252841, y: 127.26278 },
  { x: 239.042874, y: 142.964923 },
  { x: 309.714617, y: 239.027116 },
  { x: 246.035715, y: 227.830238 },
  { x: 228.576646, y: 205.83634 },
  { x: 235.172348, y: 210.44534 },
  { x: 511.759544, y: 250.096453 },
  { x: 120.370273, y: 200.653478 },
  { x: 250.804396, y: 170.662736 },
  { x: 227.837357, y: 195.625343 },
  { x: 609.30625, y: 114.685301 },
  { x: 412.95538, y: 252.196084 },
  { x: 598.656755, y: 125.376446 },
  { x: 147.739971, y: 112.582445 },
  { x: 211.208375, y: 109.72364 },
  { x: 300.289846, y: 167.226851 },
  { x: 317.899746, y: 174.3541 },
  { x: 324.530316, y: 170.548849 },
  { x: 213.359745, y: 220.600207 },
  { x: 205.979317, y: 217.92771 },
  { x: 369.028088, y: 155.317038 },
  { x: 229.954837, y: 135.072475 },
  { x: 163.290142, y: 147.942553 },
  { x: 315.024288, y: 242.01788 },
  { x: 321.066564, y: 244.871679 },
  { x: 200.334867, y: 187.308356 },
  { x: 155.388412, y: 179.388058 },
  { x: 225.115047, y: 223.46005 },
  { x: 219.236372, y: 221.383893 },
  { x: 483.814075, y: 179.797328 },
  { x: 261.973845, y: 157.404531 },
  { x: 475.541867, y: 137.007282 },
  { x: 562.601005, y: 93.631225 },
  { x: 567.403284, y: 101.076137 },
  { x: 170.274262, y: 185.833224 },
  { x: 480.459866, y: 253.981578 },
  { x: 432.409546, y: 258.049828 },
  { x: 541.124434, y: 237.57041 },
  { x: 539.715457, y: 222.130282 },
  { x: 520.173657, y: 175.419845 },
  { x: 275.047794, y: 223.901607 },
  { x: 305.804644, y: 169.77678 },
  { x: 371.783704, y: 166.200039 },
  { x: 543.70099, y: 206.604137 },
  { x: 575.718525, y: 115.8612 },
  { x: 571.830451, y: 107.609108 },
  { x: 622.016774, y: 216.184504 },
  { x: 594.073544, y: 136.876782 },
  { x: 518.685693, y: 109.314763 },
  { x: 354.510625, y: 163.616127 },
  { x: 378.120505, y: 169.842297 },
  { x: 415.857606, y: 173.631071 },
  { x: 186.352131, y: 188.584447 },
  { x: 211.019355, y: 184.636166 },
  { x: 311.17912, y: 102.867822 },
  { x: 436.711136, y: 151.637139 },
  { x: 419.988038, y: 158.285399 },
  { x: 392.195993, y: 205.369864 },
  { x: 245.216114, y: 180.917349 },
  { x: 379.672294, y: 213.336443 },
  { x: 385.728578, y: 210.863671 },
  { x: 505.697792, y: 249.23418 },
  { x: 587.007182, y: 211.724336 },
  { x: 489.672646, y: 224.747887 },
  { x: 133.954089, y: 205.008811 },
  { x: 457.835917, y: 145.804745 },
  { x: 466.257463, y: 141.497472 },
  { x: 442.740728, y: 151.827463 },
  { x: 521.163022, y: 193.131441 },
  { x: 529.103571, y: 201.328832 },
  { x: 344.821953, y: 184.72499 },
  { x: 373.916538, y: 214.652647 },
  { x: 360.726149, y: 163.562018 },
  { x: 481.157995, y: 196.417745 },
  { x: 190.0306, y: 214.479179 },
  { x: 419.288311, y: 257.563884 },
  { x: 111.499059, y: 199.600009 },
  { x: 199.569687, y: 218.955347 },
  { x: 222.230605, y: 190.676486 },
  { x: 515.142943, y: 99.668312 },
  { x: 139.311629, y: 149.844432 },
  { x: 410.32736, y: 188.749916 },
  { x: 389.846473, y: 176.592117 },
  { x: 103.789089, y: 199.655741 },
  { x: 443.95618, y: 258.201238 },
  { x: 449.187876, y: 254.642444 },
  { x: 629.901785, y: 210.927411 },
  { x: 514.770864, y: 194.873994 },
  { x: 581.865509, y: 216.125906 },
  { x: 367.055851, y: 225.808362 },
  { x: 605.574771, y: 122.257493 },
  { x: 496.044269, y: 130.416199 },
  { x: 238.909849, y: 182.408748 },
  { x: 311.113679, y: 173.138364 },
  { x: 424.984544, y: 201.953992 },
  { x: 614.269818, y: 123.714037 },
  { x: 487.766935, y: 255.262585 },
  { x: 437.990436, y: 259.538454 },
  { x: 496.236033, y: 207.551742 },
  { x: 574.613862, y: 232.040042 },
  { x: 163.453244, y: 209.556126 },
  { x: 183.979762, y: 213.491566 },
  { x: 175.115007, y: 210.454489 },
  { x: 438.151353, y: 214.399576 },
  { x: 340.380271, y: 178.068238 },
  { x: 490.550984, y: 134.695617 },
  { x: 491.165209, y: 211.21004 },
  { x: 473.625264, y: 253.537984 },
  { x: 164.125949, y: 219.544915 },
  { x: 382.888688, y: 247.924819 },
  { x: 531.984689, y: 217.343454 },
  { x: 377.060199, y: 238.235702 },
  { x: 167.420916, y: 202.983991 },
  { x: 232.519674, y: 225.143184 },
  { x: 604.217096, y: 218.817799 },
  { x: 555.745099, y: 243.398257 },
  { x: 434.191405, y: 190.620623 }
])

const townNodes = ref<{ x: number, y: number }[]>([
  { x: 363.410668, y: 228.66615 },
  { x: 466.852561, y: 226.29149 },
  { x: 212.032764, y: 184.549382 },
  { x: 283.451493, y: 168.832026 },
  { x: 288.498224, y: 161.944507 },
  { x: 331.913789, y: 167.997309 },
  { x: 300.443134, y: 166.550564 },
  { x: 462.822139, y: 143.419003 },
  { x: 254.946052, y: 225.348529 },
  { x: 540.652957, y: 214.278852 },
  { x: 292.415883, y: 133.018495 },
  { x: 326.590849, y: 226.076476 },
  { x: 472.230188, y: 136.666059 },
  { x: 407.500954, y: 229.17306 },
  { x: 331.105123, y: 251.036 },
  { x: 478.178657, y: 179.046399 },
  { x: 465.27522, y: 258.327181 },
  { x: 430.054037, y: 222.337311 },
  { x: 172.233781, y: 208.335163 },
  { x: 575.63062, y: 113.790834 },
  { x: 216.908723, y: 124.325644 },
  { x: 368.233344, y: 245.377412 },
  { x: 503.539182, y: 144.655105 },
  { x: 531.425288, y: 271.376504 },
  { x: 419.12946, y: 193.682282 },
  { x: 588.388378, y: 155.341113 },
  { x: 583.50645, y: 179.432645 },
  { x: 488.923307, y: 117.955329 },
  { x: 320.770085, y: 199.99217 },
  { x: 577.940759, y: 237.42368 }
])

const threshold = 100
const mouse = { x: -1000, y: -1000 }

const canvasWidth = 720
const canvasHeight = 360

const jsEnabled = ref(false)

let animationFrame: number | null = null

const updateMouse = (e: MouseEvent) => {
  if (!canvasRef.value) return
  const canvas = canvasRef.value
  const rect = canvas.getBoundingClientRect()

  mouse.x = ((e.clientX - rect.left) / rect.width) * canvasWidth
  mouse.y = ((e.clientY - rect.top) / rect.height) * canvasHeight
}

const resetMouse = () => {
  mouse.x = -1000
  mouse.y = -1000
}

const drawNode = (ctx: CanvasRenderingContext2D, type: 'road' | 'town', node: { x: number, y: number }) => {
  const dx = mouse.x - node.x
  const dy = mouse.y - node.y

  const distance = Math.sqrt(dx * dx + dy * dy)

  let scale = 1
  if (distance < threshold) {
    // console.log(distance)
    scale = 1 + (1 - distance / threshold) * 3
  }

  const size = (type == 'road' ? 2 : 4) * scale

  ctx.beginPath()
  ctx.ellipse(node.x, node.y, size, size, 0, 0, 2 * Math.PI)
  ctx.stroke()
  ctx.closePath()
}

const draw = () => {
  const canvas = canvasRef.value
  const ctx = canvas?.getContext('2d')

  if (!canvas || !ctx) return

  ctx.clearRect(0, 0, canvas.width, canvas.height)
  ctx.reset()

  ctx.scale(canvas.width / canvasWidth, canvas.height / canvasHeight)
  ctx.strokeStyle = '#08bcb9'
  roadNodes.value.forEach(n => drawNode(ctx, 'road', n))

  ctx.strokeStyle = '#eeaa45'
  townNodes.value.forEach(n => drawNode(ctx, 'town', n))

  animationFrame = requestAnimationFrame(draw)
}

const resizeCanvas: ResizeObserverCallback = (entries) => {
  for (const entry of entries) {
    const canvas = canvasRef.value
    if (!canvas) return

    const { width, height } = entry.contentRect
    canvas.width = width
    canvas.height = height
  }
}

let observer: ResizeObserver

onMounted(() => {
  jsEnabled.value = true
  const canvas = canvasRef.value
  if (!canvas || !canvas.parentElement) return
  observer = new ResizeObserver(resizeCanvas)
  observer.observe(canvas.parentElement)
  draw()
})

onUnmounted(() => {
  observer.disconnect()
  if (animationFrame)
    cancelAnimationFrame(animationFrame)
})
</script>

<template>
  <div
    class="w-full flex items-center justify-center overflow-hidden relative -my-16"
    :style="{ aspectRatio: `${canvasWidth}/${canvasHeight}` }"
  >
    <canvas
      ref="canvasRef"
      class="absolute w-full h-full"
      :width="canvasWidth"
      :height="canvasHeight"
      @mousemove="updateMouse"
      @mouseleave="resetMouse"
    />
    <img
      v-if="!jsEnabled"
      class="absolute w-full h-full object-contain"
      src="/images/nodes-static.png"
    >
  </div>
</template>
